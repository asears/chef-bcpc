---
- include: ../common_playbooks/validate_environment.yml
- include: ../common_playbooks/destructive_warning.yml

- hosts: "{{ target }}"
  become: yes
  gather_facts: no

  serial: 1
  tasks:
    - name: Get node FQDN
      command: hostname -f
      register: hostfqdn

    - name: Remove node from Chef server
      command: knife node delete -y {{ hostfqdn.stdout }}
      ignore_errors: yes
      delegate_to: "{{ groups['bootstraps'][0] }}"

    - name: Remove client from Chef server
      command: knife client delete -y {{ hostfqdn.stdout }}
      ignore_errors: yes
      delegate_to: "{{ groups['bootstraps'][0] }}"

    - name: Remove node from SSH known hosts on bootstrap node
      known_hosts: name={{ ansible_ssh_host }} state=absent
      delegate_to: "{{ groups['bootstraps'][0] }}"

    - name: Retrieve Chef 12 client package from bootstrap node
      get_url: url=http://{{ cluster_apt_mirror }}/chef-client/{{ chef_client_deb }} dest=/tmp/{{ chef_client_deb }}

    - name: Install Chef 12 client
      apt: deb=/tmp/{{ chef_client_deb }}

    # the below steps are done to enroll the node rather than knife bootstrap
    # because we do not keep the operations private key on any cluster member
    - name: Register validator key on bootstrap node to a variable
      command: cat /etc/chef/validation.pem
      register: chef_validator_key
      delegate_to: "{{ groups['bootstraps'][0] }}"

    - name: Create /etc/chef
      file: path=/etc/chef state=directory

    - name: Create /var/log/chef
      file: path=/var/log/chef state=directory

    - name: Remove client key if present
      file: path=/etc/chef/client.pem state=absent

    - name: Write out Chef validator key
      template: src=templates/chef_validator_key.pem.j2 dest=/etc/chef/validation.pem owner=root group=root mode=0600

    - name: Write out Chef client configuration
      template: src=templates/chef_client.rb.j2 dest=/etc/chef/client.rb owner=root group=root mode=0644

    - name: Fetch SSL certificates from Chef server
      command: knife ssl fetch -c /etc/chef/client.rb

    - name: Enroll against Chef server
      command: chef-client

    - name: Set environment for node on Chef server
      command: knife node environment set {{ hostfqdn.stdout }} {{ cluster_name }}
      delegate_to: "{{ groups['bootstraps'][0] }}"
