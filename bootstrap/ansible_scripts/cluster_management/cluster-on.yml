---
- hosts: groups['headnodes'][0]
  become: yes
  gather_facts: no
  tasks:
    - name: Power on the node
      local_action: /usr/bin/VBoxManage startvm {{ inventory_hostname }}
      sudo: no
      ignore_errors: true
      tags:
        - cluster-on

    - name: Wait for ssh to come up again....
      local_action: wait_for host={{ ansible_ssh_host }} port=22 state=started timeout=1800
      tags:
        - cluster-on

    - name: re-enable mysql
      command: update-rc.d mysql defaults
      tags:
        - cluster-on

    - name: bootstrap mysql
      command: /etc/init.d/mysql bootstrap-pxc
      tags:
        - cluster-on

    - name: check mysql
      shell: /usr/bin/clustercheck check {{ mysql_check_pass }} 0 | grep 'is synced'
      register: result
      until: result.rc == 0
      retries: 5
      delay: 10
      tags:
        - cluster-on
        - checks

- hosts: groups['headnodes'][1:]
  sudo: yes
  serial: 1
  gather_facts: no
  tasks:
    - name: start remaining head nodes
      local_action: /usr/bin/VBoxManage startvm {{inventory_hostname}}
      sudo: no
      ignore_errors: true
      tags:
        - cluster-on

    - name: Wait for ssh to come up again....
      local_action: wait_for host={{ ansible_ssh_host }} port=22 state=started timeout=1800
      tags:
        - cluster-on

    - name: check mysql
      sudo: yes
      shell: /usr/bin/clustercheck check {{ mysql_check_pass }} 0 | grep 'is synced'
      register: result
      until: result.rc == 0
      retries: 5
      delay: 10
      tags:
        - cluster-on
        - checks

- hosts: worknodes
  sudo: yes
  serial: 3
  gather_facts: no
  tasks:

    - name: start remaining work nodes
#      local_action: ilo ip={{ilo_ip}} password={{ilo_password}} powerstate=on
      command: /usr/bin/VBoxManage startvm {{inventory_hostname}}
      sudo: no
      delegate_to: "{{groups['hypervisors'][0]}}"
      ignore_errors: true
      tags:
        - cluster-on

    - name: Wait for ssh to come up again....
      local_action: wait_for host={{ ansible_ssh_host }} port=22 state=started timeout=1800
      tags:
        - cluster-on


- hosts: single-head
  sudo: yes
  serial: 1
  vars:
  tasks:
    - name: unset Ceph no-out to re-enable full Ceph healing
      sudo: yes
      command: ceph osd unset noout
      tags:
        - cluster-on

    - name: ceph health
      shell: ceph -s | grep HEALTH
      register: ceph_status
      tags:
        - cluster-on
        - checks

    - debug: var=ceph_status.stdout
      tags:
        - cluster-on
        - checks

- hosts: headnodes
  tasks:
    - name: mysql service
      sudo: yes
      command: /etc/init.d/mysql status | grep Percona
      register: mysql_status
      tags:
        - cluster-on
        - checks
        - foo

    - debug: var=mysql_status.stdout
      tags:
        - cluster-on
        - checks
        - foo

    - name: check mysql sync state
      sudo: yes
      shell: /usr/bin/clustercheck check {{ mysql_check_pass }} 0 | grep 'is synced'
      tags:
        - cluster-on
        - checks
        - foo
