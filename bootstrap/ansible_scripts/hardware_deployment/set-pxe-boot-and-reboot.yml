# This playbook will set Cobbler to allow netbooting for a given node, then
# use ipmitool on the bootstrap node to set the target
# node into PXE boot mode and perform a hard power cycle.
---
- include: ../common_playbooks/validate_environment.yml
- include: ../common_playbooks/destructive_warning.yml

- hosts: bootstraps
  become: yes
  gather_facts: no
  tasks:
    - name: Install ipmitool on bootstrap node
      apt: pkg=ipmitool state=present

- hosts: "{{ target }}"
  become: yes
  gather_facts: no
  serial: 1
  tasks:
    - name: Enable Cobbler netboot for node
      command: cobbler system edit --name={{ inventory_hostname }} --netboot-enabled=true
      delegate_to: "{{ groups['bootstraps'][0] }}"

    - include: tasks-hardware-set-pxe-boot-and-reboot.yml
      when: hardware_type != "Virtual"

    - include: tasks-virtualized-set-pxe-boot-and-reboot.yml
      when: hardware_type == "Virtual"
